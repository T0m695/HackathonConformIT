<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©poser une alerte - TechnoPlast</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <style>
        .alert-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .alert-form {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #1e293b;
        }
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
        }
        .btn-record {
            width: 100%;
            padding: 1.5rem;
            font-size: 1.2rem;
            font-weight: 600;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 2rem;
        }
        .btn-record:hover {
            background: #c82333;
        }
        .btn-submit {
            width: 100%;
            padding: 1rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-submit:hover {
            background: #1e40af;
        }
        .back-link {
            color: #2563eb;
            text-decoration: none;
            margin-bottom: 1rem;
            display: inline-block;
        }
        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            text-align: center;
        }
        .status-recording {
            background: #fee;
            color: #dc2626;
        }
        .status-success {
            background: #d1fae5;
            color: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üö® D√©poser une alerte</h1>
        </header>

        <div class="alert-container">
            <a href="/" class="back-link">‚Üê Retour au tableau de bord</a>
            
            <div class="alert-form">
                <h2>üì¢ Signaler un incident</h2>
                <p style="color: #64748b; margin-bottom: 2rem;">Cliquez sur le bouton pour enregistrer votre d√©claration vocale.</p>

                <div id="statusMessage" style="display: none;"></div>

                <button id="recordButton" class="btn-record">
                    üé§ Commencer l'enregistrement
                </button>

                <div class="form-group">
                    <label for="eventType">Type d'√©v√©nement</label>
                    <select id="eventType">
                        <option value="EHS">EHS (Sant√© & S√©curit√©)</option>
                        <option value="ENVIRONMENT">Environnement</option>
                        <option value="DAMAGE">Dommage mat√©riel</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="classification">Classification</label>
                    <select id="classification">
                        <option value="PREVENTIVE_DECLARATION">D√©claration pr√©ventive</option>
                        <option value="NEAR_MISS">Presque-accident</option>
                        <option value="FIRST_AID">Premiers soins</option>
                        <option value="INJURY">Blessure</option>
                        <option value="EQUIPMENT_FAILURE">D√©faillance √©quipement</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="unitId">Unit√© organisationnelle</label>
                    <select id="unitId">
                        <option value="126" selected>Injection Molding Line A</option>
                        <option value="127">Injection Molding Line B</option>
                        <option value="128">Injection Molding Line C</option>
                        <option value="129">Injection Molding Line D</option>
                    </select>
                </div>

                <button id="submitButton" class="btn-submit" style="display: none;">
                    Cr√©er l'√©v√©nement
                </button>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let transcribedText = '';
        const recordButton = document.getElementById('recordButton');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');

        // Demander l'acc√®s au microphone au chargement
        let autoStopTimer = null;
        const MAX_RECORD_MS = 55000; // s√©curit√©: 55s max

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onerror = (err) => {
                    console.error('MediaRecorder error:', err);
                    showStatus('‚ùå Erreur lors de l\'enregistrement', 'recording');
                    isRecording = false;
                    recordButton.disabled = false;
                    recordButton.textContent = 'üé§ Commencer l\'enregistrement';
                    recordButton.style.background = '#dc3545';
                };

                mediaRecorder.onstop = async () => {
                    clearTimeout(autoStopTimer);
                    // Construire le Blob avec le type r√©el produit par MediaRecorder
                    const mimeType = audioChunks.length && audioChunks[0].type ? audioChunks[0].type : 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    audioChunks = [];

                    // Mettre √† jour l'UI pendant le traitement
                    recordButton.disabled = true;
                    recordButton.textContent = '‚è≥ Traitement...';
                    showStatus('‚è≥ Transcription en cours avec AWS...', 'recording');

                    // Envoyer l'audio pour transcription
                    await transcribeAudio(audioBlob);

                    // R√©activer si n√©cessaire (transcribeAudio affichera le submit button)
                    recordButton.disabled = false;
                    recordButton.textContent = 'üé§ Commencer l\'enregistrement';
                    recordButton.style.display = 'none';
                };
            })
            .catch(error => {
                console.error('Erreur acc√®s micro:', error);
                showStatus('‚ùå Impossible d\'acc√©der au microphone', 'recording');
            });

        recordButton.addEventListener('click', async () => {
            if (!mediaRecorder) {
                alert('Microphone non disponible. Veuillez autoriser l\'acc√®s.');
                return;
            }

            try {
                if (mediaRecorder.state !== 'recording') {
                    // Commencer l'enregistrement
                    audioChunks = [];
                    mediaRecorder.start();
                    isRecording = true;
                    recordButton.textContent = '‚èπÔ∏è Arr√™ter l\'enregistrement';
                    recordButton.style.background = '#28a745';
                    showStatus('üî¥ Enregistrement en cours... Parlez maintenant!', 'recording');

                    // S√©curit√©: arr√™ter automatiquement apr√®s MAX_RECORD_MS
                    autoStopTimer = setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            console.warn('Auto-stop du m√©dia apr√®s timeout');
                            mediaRecorder.stop();
                        }
                    }, MAX_RECORD_MS);
                } else {
                    // Arr√™ter l'enregistrement
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                    isRecording = false;
                }
            } catch (err) {
                console.error('Erreur lors du contr√¥le de l\'enregistrement:', err);
                showStatus('‚ùå Erreur lors du contr√¥le de l\'enregistrement', 'recording');
                isRecording = false;
                recordButton.disabled = false;
                recordButton.textContent = 'üé§ Commencer l\'enregistrement';
                recordButton.style.background = '#dc3545';
            }
        });

        async function transcribeAudio(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio_file', audioBlob, 'recording.wav');
                
                console.log('üì§ Envoi de l\'audio pour transcription...');
                
                const response = await fetch('/api/transcribe-audio', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                console.log('üì• R√©sultat transcription:', result);
                
                if (result.success) {
                    transcribedText = result.transcription;
                    const displayText = transcribedText.length > 100 
                        ? transcribedText.substring(0, 100) + '...' 
                        : transcribedText;
                    
                    showStatus('‚úÖ Transcription termin√©e: "' + displayText + '"', 'success');
                    
                    if (result.simulated) {
                        showStatus('‚ö†Ô∏è Mode simulation - AWS non configur√©. Transcription: "' + displayText + '"', 'recording');
                    }
                    
                    submitButton.style.display = 'block';
                    recordButton.style.display = 'none';
                } else {
                    throw new Error(result.error || 'Erreur de transcription');
                }
            } catch (error) {
                console.error('‚ùå Erreur transcription:', error);
                showStatus('‚ùå Erreur lors de la transcription: ' + error.message, 'recording');
                recordButton.disabled = false;
                recordButton.textContent = 'üé§ Commencer l\'enregistrement';
                recordButton.style.background = '#dc3545';
                isRecording = false;
            }
        }

        submitButton.addEventListener('click', async () => {
            if (!transcribedText || transcribedText.trim().length < 10) {
                alert('‚ö†Ô∏è La transcription est trop courte (minimum 10 caract√®res). Veuillez enregistrer √† nouveau.');
                return;
            }
            
            submitButton.disabled = true;
            submitButton.textContent = '‚è≥ Cr√©ation en cours...';
            
            const eventData = {
                declared_by_id: 1001,  // Employ√© par d√©faut pour transcription audio
                organizational_unit_id: parseInt(document.getElementById('unitId').value),
                event_type: document.getElementById('eventType').value,
                classification: document.getElementById('classification').value,
                description: transcribedText
            };
            
            console.log('üì§ Envoi des donn√©es:', eventData);
            
            try {
                const response = await fetch('/api/create-event-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });
                
                const result = await response.json();
                console.log('üì• R√©ponse serveur:', result);
                
                if (response.ok && result.success) {
                    showStatus('‚úÖ √âv√©nement cr√©√© avec succ√®s! ID: ' + result.event.event_id, 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    const errorMsg = result.detail || result.message || 'Erreur lors de la cr√©ation';
                    throw new Error(errorMsg);
                }
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                showStatus('‚ùå Erreur: ' + error.message, 'recording');
                submitButton.disabled = false;
                submitButton.textContent = 'Cr√©er l\'√©v√©nement';
            }
        });

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message status-' + type;
            statusMessage.style.display = 'block';
        }
    </script>
</body>
</html>
